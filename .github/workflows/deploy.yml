name: Deploy NYX to VPS (PNPM Monorepo)

on:
  push:
    branches:
      - main # Pastikan ini sesuai branch lu

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # --- SETUP PNPM ---
      - name: ðŸ¦€ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      # --- PHASE 1: INSTALL SEMUA (ROOT) ---
      - name: ðŸ“¦ Install Dependencies (Root)
        run: pnpm install --no-frozen-lockfile

      # --- PHASE 2: BUILD WEB ---
      - name: ðŸŽ¨ Build Web (Frontend)
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_WS_URL: ${{ secrets.VITE_WS_URL }}
          VITE_APP_SECRET: ${{ secrets.VITE_APP_SECRET }}
          VITE_VAPID_PUBLIC_KEY: ${{ secrets.VITE_VAPID_PUBLIC_KEY }}
        run: pnpm --filter ./web run build

      # --- PHASE 3: BUILD SERVER (YANG DIPERBAIKI) ---
      - name: âš™ï¸ Build Server (Backend)
        working-directory: ./server
        run: |
          # WAJIB: Generate Prisma Client dulu biar TypeScript kenal tipe datanya
          npx prisma@5.22.0 generate
          
          # Baru di-build
          pnpm run build

      # --- PHASE 4: PACKAGING ---
      - name: ðŸ—œï¸ Prepare Artifacts for Deploy
        run: |
          mkdir deploy_package
          
          # Copy Frontend Build
          mkdir -p deploy_package/web
          cp -r web/dist deploy_package/web/
          
          # Copy Backend Build & Configs
          mkdir -p deploy_package/server
          cp -r server/dist deploy_package/server/
          cp server/package.json deploy_package/server/
          cp -r server/prisma deploy_package/server/
          
          # Zip semuanya
          cd deploy_package
          zip -r ../nyx-deploy.zip .

      # --- PHASE 5: SHIP TO VPS ---
      - name: ðŸš€ Upload to VPS via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          port: ${{ secrets.VPS_PORT }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          source: "nyx-deploy.zip"
          target: "/root/"

      # --- PHASE 6: EXECUTE ON VPS ---
      - name: ðŸ”§ Unzip & Restart on VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          port: ${{ secrets.VPS_PORT }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            echo "ðŸš§ Starting Deployment..."
            
            # Cek pnpm
            if ! command -v pnpm &> /dev/null; then
                npm install -g pnpm
            fi

            mkdir -p /root/nyx-app
            
            # Unzip
            unzip -o /root/nyx-deploy.zip -d /root/nyx-app/
            rm /root/nyx-deploy.zip
            
            # Setup Backend
            echo "ðŸ“¦ Installing Backend Dependencies..."
            cd /root/nyx-app/server
            
            # Install prod dependencies
            pnpm install --prod
            
            # Generate Prisma (Di VPS juga perlu biar runtime-nya jalan)
            npx prisma generate
            
            # Restart Apps
            echo "ðŸ”„ Restarting Apps..."
            pm2 restart nyx-api || pm2 start dist/index.js --name "nyx-api"
            pm2 restart nyx-web || pm2 start "pnpm dlx serve -s ../web/dist -l 3000" --name "nyx-web"
            
            echo "âœ… Deployment Success!"